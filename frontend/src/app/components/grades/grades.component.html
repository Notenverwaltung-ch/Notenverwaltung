<div class="container">
  <h1>Noten</h1>

  <section class="card">
    <h2>Note erstellen</h2>
    <form [formGroup]="form" (ngSubmit)="onAdd()" class="grid">
      <ng-container *ngIf="isAdmin; else noStudentSelection">
        <label>
          <span>Schüler*</span>
          <select formControlName="studentId" [disabled]="optionsLoading || adding">
            <option value="" disabled>Schüler auswählen</option>
            <option *ngFor="let s of students" [value]="s.id">{{ s.username }}</option>
          </select>
        </label>
      </ng-container>
      <ng-template #noStudentSelection>
        <div class="info col-span-2">Note für dein eigenes Konto hinzufügen</div>
      </ng-template>
      <label>
        <span>Test</span>
        <select formControlName="testId" [disabled]="optionsLoading || adding">
          <option value="">Kein Test</option>
          <option *ngFor="let t of testsList" [value]="t.id">{{ t.name }}</option>
        </select>
      </label>
      <label>
        <span>Wert*</span>
        <input type="number" step="0.01" formControlName="value" required/>
      </label>
      <label>
        <span>Gewichtung*</span>
        <input type="number" step="0.01" formControlName="weight"/>
      </label>
      <label class="col-span-2">
        <span>Bemerkung</span>
        <input formControlName="comment"/>
      </label>
      <div class="actions col-span-2">
        <button class="btn" type="submit"
                [disabled]="form.invalid || adding">{{ adding ? 'Wird erstellt...' : 'Erstellen' }}
        </button>
      </div>
    </form>
    <p class="error" *ngIf="error">{{ error }}</p>
    <p class="error" *ngIf="optionsError">{{ optionsError }}</p>
    <p class="success" *ngIf="success">{{ success }}</p>
  </section>

  <section class="card">
    <div class="card-header">
      <h2>Notenliste</h2>
      <div class="spacer"></div>
      <label *ngIf="isAdmin">
        <input type="checkbox" [(ngModel)]="showOnlyOwn" (change)="pageIndex=0; load()"/> Nur eigene anzeigen
      </label>
      <label>Seitengrösse
        <select [(ngModel)]="size" (change)="pageIndex=0; load()">
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </label>
    </div>

    <table class="table">
      <thead>
      <tr>
        <th class="sortable" (click)="toggleSort('value')">
          Wert <span class="sort-indicator" *ngIf="sortField==='value'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span>
        </th>
        <th class="sortable" (click)="toggleSort('weight')">
          Gewichtung <span class="sort-indicator"
                           *ngIf="sortField==='weight'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span>
        </th>
        <th class="sortable" (click)="toggleSort('comment')">
          Bemerkung <span class="sort-indicator"
                          *ngIf="sortField==='comment'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span>
        </th>
        <th class="sortable" (click)="toggleSort('studentUsername')">
          Schüler <span class="sort-indicator"
                        *ngIf="sortField==='studentUsername'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span>
        </th>
        <th class="sortable" (click)="toggleSort('testName')">
          Test <span class="sort-indicator" *ngIf="sortField==='testName'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span>
        </th>
        <th class="sortable" (click)="toggleSort('createdOn')">
          Erstellt <span class="sort-indicator"
                         *ngIf="sortField==='createdOn'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span>
        </th>
        <th>Aktionen</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let g of page?.content">
        <td>{{ g.value }}</td>
        <td>{{ g.weight }}</td>
        <td>{{ g.comment }}</td>
        <td>{{ g.studentUsername }}</td>
        <td>{{ g.testName }}</td>
        <td>{{ g.createdOn | date:'yyyy-MM-dd HH:mm' }}</td>
        <td>
          <button class="btn btn-danger" *ngIf="isAdmin || isOwner(g)" (click)="onDelete(g)"
                  [disabled]="deletingId===g.id">
            {{ deletingId === g.id ? 'Wird gelöscht...' : 'Löschen' }}
          </button>
        </td>
      </tr>
      </tbody>
    </table>

    <div class="pagination">
      <button class="btn" (click)="prev()" [disabled]="page?.number===0 || loading">Zurück</button>
      <span>Seite {{ (page?.number ?? 0) + 1 }} / {{ page?.totalPages ?? 1 }}</span>
      <button class="btn" (click)="next()" [disabled]="(page?.number ?? 0) >= (page?.totalPages ?? 1) - 1 || loading">
        Weiter
      </button>
    </div>

    <p *ngIf="loading">Wird geladen...</p>
    <p class="error" *ngIf="listError">{{ listError }}</p>
  </section>
</div>
